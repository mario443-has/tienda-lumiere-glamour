{% load static %}
<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{% block title %}Lumière Glamour{% endblock %}</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Great Vibes para el logo, Inter para el texto general -->
    <link
      href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <!-- Font Awesome para íconos -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
    <!-- Estilos personalizados para categorías -->
    <link rel="stylesheet" href="{% static 'css/categorias.css' %}">
    {# Este bloque es para CSS o meta tags adicionales específicos de una página #}
    {% block extra_head %}{% endblock %}
    <style>
      /* Estilo personalizado para la fuente del logo */
      .font-great-vibes {
        font-family: "Great Vibes", cursive;
      }
      /* Estilos para el scrollbar (opcional, para una estética más limpia) */
      ::-webkit-scrollbar {
        width: 8px;
      }
      ::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
      }
      ::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 10px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #555;
      }
      /* Ocultar scrollbar pero mantener funcionalidad de scroll */
      #slider::-webkit-scrollbar {
        display: none;
      }
      #slider {
        -ms-overflow-style: none; /* IE and Edge */
        scrollbar-width: none; /* Firefox */
      }

      /* Estilos específicos para el carrusel de anuncios */
      #announcement-carousel-wrapper {
        position: relative;
        width: 100%;
        height: 12rem; /* Altura para móviles */
        overflow: hidden;
      }
      @media (min-width: 640px) { /* sm breakpoint */
        #announcement-carousel-wrapper {
          height: 16rem; /* Altura para tablets */
        }
      }
      @media (min-width: 768px) { /* md breakpoint */
        #announcement-carousel-wrapper {
          height: 20rem; /* Altura para escritorio */
        }
      }

      #announcement-carousel {
        display: flex;
        width: 100%;
        height: 100%;
        transition: transform 0.5s ease-in-out;
      }
      .carousel-item {
        flex: 0 0 100%;
        height: 100%;
        position: relative;
      }
      .carousel-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }
      /* Estilos para los círculos de color */
      .color-option {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        cursor: pointer;
        border: 2px solid transparent;
        transition: all 0.2s ease-in-out;
      }
      .color-option.selected {
        border-color: #f687b3; /* Un rosa más oscuro para el borde seleccionado */
        box-shadow: 0 0 0 2px #fff, 0 0 0 4px #f687b3; /* Borde doble para resaltar */
      }
      .color-option:hover {
        transform: scale(1.1);
      }
      /* Estilo para el botón de "más colores" */
      .more-colors-button {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background-color: #f687b3; /* Color de fondo rosa */
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        cursor: pointer;
        transition: background-color 0.2s ease-in-out;
      }
      .more-colors-button:hover {
        background-color: #d85c8e; /* Rosa más oscuro al pasar el ratón */
      }
      /* Contenedor para colores adicionales */
      .additional-colors-container {
        display: none; /* Oculto por defecto */
        flex-wrap: wrap; /* Permite que los colores se envuelvan si hay muchos */
        gap: 8px; /* Espacio entre los círculos de color */
        margin-top: 8px; /* Espacio superior para separar de los primeros 3 */
      }
      .additional-colors-container.visible {
        display: flex; /* Visible cuando se activa */
      }

      /* Estilos Mejorados para Categorías (Añadidos aquí) */
      .categorias-nav {
          margin-bottom: 2rem;
      }
      .categoria-item {
          margin-bottom: 1rem;
      }
      .categoria-link {
          display: block;
          padding: 0.5rem;
          color: inherit;
          text-decoration: none;
          border-bottom: 2px solid transparent;
          transition: border-color 0.3s ease;
      }
      .categoria-link:hover {
          /* Usar un color que contraste con tu tema, por ejemplo, el rosa de tu logo */
          border-bottom-color: #EC4899; /* Tailwind pink-500 */
      }
      .subcategorias {
          margin-left: 1.5rem;
          padding-left: 1.5rem;
          /* Usar un color que contraste con tu tema */
          border-left: 2px solid #D1D5DB; /* Tailwind gray-300 */
      }
      .subcategoria-link {
          display: block;
          margin-bottom: 0.5rem;
          /* Usar un color que contraste con tu tema */
          color: #4B5563; /* Tailwind gray-700 */
          text-decoration: none;
      }
      .subcategoria-link:hover {
          /* Usar un color que contraste con tu tema, por ejemplo, el rosa de tu logo */
          color: #EC4899; /* Tailwind pink-500 */
      }
      @media (max-width: 768px) {
          .categorias-container {
              position: fixed;
              left: 0;
              top: 4rem; /* Ajustar si tu header tiene otra altura */
              bottom: 0;
              width: 250px;
              overflow-y: auto;
              /* Usar un color que contraste con tu tema */
              background: #FFFFFF; /* Tailwind white */
              box-shadow: 2px 0 5px rgba(0,0,0,0.1);
              z-index: 1000;
          }
          .categorias-lista {
              padding: 1rem;
          }
      }
    </style>

    <!-- Google tag (gtag.js) -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-RPSFD64V89"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());

      gtag("config", "G-RPSFD64V89");
    </script>
  </head>

  <body class="bg-gray-100 font-inter text-gray-800">
    <!-- Header Section - Barra de Navegación Unificada -->
    <header class="bg-white shadow-md sticky top-0 z-50">
      <!-- Barra Superior de Información -->
      <div
        class="bg-gradient-to-r from-pink-500 to-purple-600 text-white text-center text-sm py-2 px-4"
      >
        <span>Envíos a toda Colombia 100% seguros y garantizados</span>
      </div>

      <div
        class="container mx-auto px-4 py-3 flex justify-between items-center"
      >
        <!-- Logo de la tienda -->
        <a href="{% url 'home' %}" class="flex items-center space-x-2">
          <img
            src="{% static 'img/logo.png' %}"
            alt="Lumière Glamour Logo"
            class="h-16 sm:h-20 w-auto rounded-full shadow-md" {# Ajuste de tamaño para móvil #}
          />
          <span
            class="text-3xl font-great-vibes text-pink-600 hover:text-pink-700 transition duration-300"
          >
            Lumiere Glamour
          </span>
        </a>

        <!-- Barra de Búsqueda (Desktop) -->
        <form
          action="{% url 'home' %}"
          method="get"
          class="hidden md:flex items-center flex-grow max-w-md mx-4"
        >
          <input
            type="text"
            name="q"
            placeholder="Buscar productos..."
            class="w-full px-4 py-2 border border-gray-300 rounded-l-md focus:outline-none focus:ring-2 focus:ring-pink-500"
            value="{{ request.GET.q|default:'' }}"
          />
          <button
            type="submit"
            class="bg-pink-600 text-white px-4 py-2 rounded-r-md hover:bg-pink-700 transition duration-300"
          >
            <i class="fas fa-search"></i>
          </button>
        </form>

        <!-- Iconos de Usuario y Carrito (Desktop) -->
        <div class="hidden md:flex items-center space-x-4">
          <!-- Ícono de usuario comentado temporalmente -->
          <!-- <a href="#" class="text-gray-700 hover:text-pink-600 transition duration-300" title="Mi Cuenta">
                    <i class="fas fa-user text-xl"></i>
                </a> -->
          <a href="{% url 'ver_carrito' %}" class="relative text-gray-700 hover:text-pink-600 transition duration-300" title="Mi Carrito">
            <i class="fas fa-shopping-bag text-xl"></i>
            <span id="cart-count" class="absolute -top-2 -right-2 bg-pink-600 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
          </a>
        </div>

        <!-- Botón del Menú Móvil (Hamburger) -->
        <button
          id="mobile-menu-button"
          class="md:hidden text-gray-700 hover:text-pink-600 focus:outline-none"
        >
          <svg
            class="w-6 h-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M4 6h16M4 12h16M4 18h16"
            ></path>
          </svg>
        </button>
      </div>

      <!-- Menú de Navegación Principal (Desktop) -->
      <nav class="hidden md:flex justify-center py-2 bg-gray-50 shadow-inner">
        <ul class="flex space-x-8">
          <li>
            <a
              href="{% url 'home' %}"
              class="text-gray-700 hover:text-pink-600 font-medium transition duration-300"
              >Inicio</a
            >
          </li>

          <li class="relative group">
            <button
              class="flex items-center text-gray-700 hover:text-pink-600 font-medium transition duration-300 focus:outline-none"
            >
              Categorías
              <svg
                class="ml-1 w-4 h-4"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19 9l-7 7-7-7"
                ></path>
              </svg>
            </button>
            <div
              class="absolute left-0 mt-2 w-64 bg-white rounded-md shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-300 transform scale-95 group-hover:scale-100 origin-top"
            >
              <div class="py-1">
                {# Iterar sobre categorías principales para la nueva estructura jerárquica #}
                {% for categoria_principal in categorias_principales %}
                  <div class="relative group/sub">
                    <a
                      href="{% url 'categoria' categoria_principal.slug %}" {# Apunta a la categoría principal #}
                      class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-pink-600 flex justify-between items-center"
                    >
                      {{ categoria_principal.nombre }}
                      {% if categoria_principal.subcategorias.all %} {# Comprueba si tiene subcategorías #}
                      <svg
                        class="w-4 h-4 transform rotate-90 group-hover/sub:rotate-0 transition-transform duration-200"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M9 5l7 7-7 7"
                        ></path>
                      </svg>
                      {% endif %}
                    </a>
                    {% if categoria_principal.subcategorias.all %} {# Si tiene subcategorías, crea el submenú #}
                    <div
                      class="absolute left-full top-0 ml-1 w-48 bg-white rounded-md shadow-lg opacity-0 invisible group-hover/sub:opacity-100 group-hover/sub:visible transition-all duration-300 transform scale-95 group-hover/sub:scale-100 origin-top-left"
                    >
                      {# Iterar sobre las subcategorías de la categoría principal #}
                      {% for subcategoria in categoria_principal.subcategorias.all %}
                      <a
                        href="{% url 'categoria' subcategoria.slug %}" {# Apunta a la subcategoría #}
                        class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-pink-600"
                      >
                        {{ subcategoria.nombre }}
                      </a>
                      {% endfor %}
                    </div>
                    {% endif %}
                  </div>
                {% empty %}
                  <a href="#" class="block px-4 py-2 text-sm text-gray-500">No hay categorías disponibles.</a>
                {% endfor %}
              </div>
            </div>
          </li>
          <!-- Elementos de menú configurables desde el admin (MenuItem) -->
          {% if menu_items %} {% for item in menu_items %}
          <li>
            <a
              href="{{ item.url }}"
              class="text-gray-700 hover:text-pink-600 font-medium transition duration-300"
              >{{ item.nombre }}</a
            >
          </li>
          {% endfor %} {% else %}
          <!-- Ejemplos de enlaces si no se configuran desde el admin -->
          <li>
            <a
              href="{% url 'home' %}"
              class="text-gray-700 hover:text-pink-600 font-medium transition duration-300"
              >Ofertas</a
            >
          </li>
          <li>
            <a
              href="#"
              class="text-gray-700 hover:text-pink-600 font-medium transition duration-300"
              >Contacto</a
            >
          </li>
          <li>
            <a
              href="#"
              class="text-gray-700 hover:text-pink-600 font-medium transition duration-300"
              >Cibermake</a
            >
          </li>
          <li>
            <a
              href="#"
              class="text-gray-700 hover:text-pink-600 font-medium transition duration-300"
              >Blog</a
            >
          </li>
          {% endif %}
        </ul>
      </nav>

      <!-- Menú Móvil (Oculto por defecto) -->
      <div id="mobile-menu" class="hidden md:hidden bg-white shadow-lg pb-4">
        <!-- Barra de Búsqueda (Móvil) -->
        <form action="{% url 'home' %}" method="get" class="px-4 py-2">
          <div class="flex">
            <input
              type="text"
              name="q"
              placeholder="Buscar productos..."
              class="w-full px-4 py-2 border border-gray-300 rounded-l-md focus:outline-none focus:ring-2 focus:ring-pink-500"
              value="{{ request.GET.q|default:'' }}"
            />
            <button
              type="submit"
              class="bg-pink-600 text-white px-4 py-2 rounded-r-md hover:bg-pink-700 transition duration-300"
            >
              <i class="fas fa-search"></i>
            </button>
          </div>
        </form>

        <a
          href="{% url 'home' %}"
          class="block px-4 py-2 text-gray-700 hover:bg-gray-100 hover:text-pink-600"
          >Inicio</a
        >

        <!-- Categorías Desplegables Móviles -->
        <div class="relative">
          <button
            id="mobile-categories-button"
            class="w-full text-left px-4 py-2 text-gray-700 hover:bg-gray-100 hover:text-pink-600 flex justify-between items-center"
            onclick="toggleSubmenu(this)"
          >
            Categorías
            <svg
              class="ml-1 w-4 h-4 transform rotate-0 transition-transform duration-200"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M19 9l-7 7-7-7"
              ></path>
            </svg>
          </button>
          <div
            id="mobile-categories-dropdown"
            class="hidden pl-8 py-1 bg-gray-50"
          >
            {# Bucle para Categorías en Móvil con jerarquía #}
            {% for categoria_principal in categorias_principales %}
            <div class="relative">
              <button
                class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-pink-600 flex justify-between items-center"
                onclick="toggleSubmenu(this)"
              >
                <a href="{% url 'categoria' categoria_principal.slug %}" class="flex-grow">{{ categoria_principal.nombre }}</a> {# Enlace directo para la categoría principal #}
                {% if categoria_principal.subcategorias.all %}
                <svg
                  class="w-4 h-4 transform rotate-90 transition-transform duration-200"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 5l7 7-7 7"
                  ></path>
                </svg>
                {% endif %}
              </button>
              {% if categoria_principal.subcategorias.all %}
              <div class="hidden pl-4 py-1 bg-gray-100">
                {% for subcategoria in categoria_principal.subcategorias.all %}
                <a
                  href="{% url 'categoria' subcategoria.slug %}" {# Apunta a la subcategoría #}
                  class="block px-4 py-2 text-xs text-gray-700 hover:bg-gray-200 hover:text-pink-600"
                  >{{ subcategoria.nombre }}</a
                >
                {% endfor %}
              </div>
              {% endif %}
            </div>
            {% empty %}
            <a href="#" class="block px-4 py-2 text-sm text-gray-500"
              >No hay categorías disponibles.</a
            >
            {% endfor %}
          </div>
        </div>
        <!-- Elementos de menú configurables para móvil -->
        {% if menu_items %} {% for item in menu_items %}
        <a
          href="{{ item.url }}"
          class="block px-4 py-2 text-gray-700 hover:bg-gray-100 hover:text-pink-600"
          >{{ item.nombre }}</a
        >
        {% endfor %} {% else %}
        <a
          href="{% url 'home' %}"
          class="block px-4 py-2 text-gray-700 hover:bg-gray-100 hover:text-pink-600"
          >Ofertas</a
        >
        <a
          href="#"
          class="block px-4 py-2 text-gray-700 hover:bg-gray-100 hover:text-pink-600"
          >Contacto</a
        >
        <a
          href="#"
          class="block px-4 py-2 text-gray-700 hover:bg-gray-100 hover:text-pink-600"
          >Cibermake</a
        >
        <a
          href="#"
          class="block px-4 py-2 text-gray-700 hover:bg-gray-100 hover:text-pink-600"
          >Blog</a
        >
        {% endif %}
        <!-- Iconos de Usuario y Carrito (Móvil) -->
        <div class="px-4 py-2 flex space-x-4 border-t border-gray-200 mt-2">
          <!-- Ícono de usuario comentado temporalmente -->
          <!-- <a href="#" class="text-gray-700 hover:text-pink-600 transition duration-300" title="Mi Cuenta">
        <i class="fas fa-user text-xl"></i> Mi Cuenta
    </a> -->
          <a
            href="{% url 'ver_carrito' %}" {# Enlace al carrito #}
            class="relative text-gray-700 hover:text-pink-600 transition duration-300"
            title="Mi Carrito"
          >
            <i class="fas fa-shopping-bag text-xl"></i>
            <span
              id="mobile-cart-count"
              class="absolute -top-2 -right-2 bg-pink-600 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center hidden"
              >0</span
            >
          </a>
        </div>
      </div>
    </header>

    {# Contenido dinámico de cada página #}
    {% block content %}
    {% endblock %}

    <!-- Footer Section -->
    <footer class="bg-gray-800 text-white py-8 mt-8">
      <div class="container mx-auto px-4 grid grid-cols-1 md:grid-cols-3 gap-8">
        <div class="footer-col text-center md:text-left">
          <h4 class="text-xl font-semibold mb-4">Lumiere Glamour</h4>
          <p class="text-gray-300">
            Tienda de maquillaje profesional, cuidado facial y accesorios.
          </p>
          <p class="text-gray-300 mt-2">
            <strong>Ipiales - Nariño - Colombia</strong>
          </p>
        </div>
        <div class="footer-col text-center md:text-left">
          <h4 class="text-xl font-semibold mb-4">Enlaces Rápidos</h4>
          <ul>
            <li class="mb-2">
              <a
                href="#"
                class="text-gray-300 hover:text-pink-500 transition duration-300"
                >Brochas</a

              >
            </li>
            <li class="mb-2">
              <a
                href="#"
                class="text-gray-300 hover:text-pink-500 transition duration-300"
                >Bases</a
              >
            </li>
            <li class="mb-2">
              <a
                href="#"
                class="text-gray-300 hover:text-pink-500 transition duration-300"
                >Cuidado Facial</a
              >
            </li>
            <li class="mb-2">
              <a
                href="#"
                class="text-gray-300 hover:text-pink-500 transition duration-300"
                >Descuentos</a
              >
            </li>
          </ul>
        </div>
        <div class="footer-col text-center md:text-left">
          <h4 class="text-xl font-semibold mb-4">Contáctanos</h4>
          <div class="space-y-2">
            <a
              href="https://wa.me/573007221200"
              target="_blank"
              class="text-gray-300 hover:text-pink-500 transition duration-300 flex items-center justify-center md:justify-start"
              title="Enviar mensaje por WhatsApp"
            >
              <i class="fab fa-whatsapp mr-2"></i> WhatsApp
            </a>

            <a
              href="https://www.instagram.com/lumiere_glamour_"
              target="_blank"
              class="text-gray-300 hover:text-pink-500 transition duration-300 flex items-center justify-center md:justify-start"
              title="Visitar Instagram"
            >
              <i class="fab fa-instagram mr-2"></i> Instagram
            </a>

            <a
              href="https://www.facebook.com/share/16uFunJpCr/?mibextid=wwXIfr"
              target="_blank"
              class="text-gray-300 hover:text-pink-500 transition duration-300 flex items-center justify-center md:justify-start"
              title="Ir a nuestra página de Facebook"
            >
              <i class="fab fa-facebook mr-2"></i> Facebook
            </a>

            <a
              href="https://www.tiktok.com/@lumiere.glamour3"
              target="_blank"
              class="text-gray-300 hover:text-pink-500 transition duration-300 flex items-center justify-center md:justify-start"
              title="Ver en TikTok"
            >
              <i class="fab fa-tiktok mr-2"></i> TikTok
            </a>
          </div>
        </div>
      </div>
      <p class="copyright text-center text-gray-400 text-sm mt-8">
        © {{ "now"|date:"Y" }} Lumiere Glamour. Todos los derechos reservados.
      </p>
    </footer>

    <!-- BOTÓN FLOTANTE WHATSAPP (General) -->
    <a
      href="https://wa.me/{{ whatsapp_number|default:'573007221200' }}?text=Hola%2C%20tengo%20una%20consulta%20general."
      class="whatsapp-flotante fixed bottom-6 right-6 bg-green-500 text-white p-4 rounded-full shadow-lg hover:bg-green-600 transition duration-300 z-40"
      target="_blank"
      title="Escríbenos por WhatsApp (Consulta General)"
    >
      <i class="fab fa-whatsapp text-2xl"></i>
    </a>

    <!-- NUEVO BOTÓN FLOTANTE "Comprar por WhatsApp" (para el carrito) -->
    <button
      id="buy-whatsapp-button"
      class="fixed bottom-20 right-6 bg-purple-600 text-white py-3 px-4 rounded-full shadow-lg hover:bg-purple-700 transition duration-300 z-40 flex items-center space-x-2 hidden"
    >
      <i class="fab fa-whatsapp text-xl"></i>
      <span>Comprar Carrito</span>
      <span
        id="buy-whatsapp-cart-count"
        class="bg-white text-purple-600 text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center"
        >0</span
      >
    </button>

    <!-- MODAL DEL CARRITO -->
    <div
      id="cart-modal"
      class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden"
    >
      <div
        class="bg-white rounded-lg shadow-xl p-6 w-11/12 max-w-md mx-auto transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full"
      >
        <!-- Encabezado del Modal -->
        <div
          class="flex justify-between items-center pb-3 border-b border-gray-200"
        >
          <h3 class="text-2xl font-semibold text-gray-900">Tu Carrito</h3>
          <button
            type="button"
            class="text-gray-400 hover:text-gray-600"
            onclick="closeCartModal()"
          >
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>

        <!-- Cuerpo del Modal - Lista de Productos -->
        <div id="cart-items-container" class="py-4 max-h-80 overflow-y-auto">
          <!-- Los productos del carrito se renderizarán aquí dinámicamente -->
          <p class="text-gray-500 text-center" id="empty-cart-message">
            El carrito está vacío.
          </p>
        </div>

        <!-- Pie del Modal - Total y Botones -->
        <div class="pt-4 border-t border-gray-200">
          <div class="flex justify-between items-center mb-4">
            <span class="text-xl font-semibold text-gray-900">Total:</span>
            <span id="cart-total" class="text-2xl font-bold text-pink-600"
              >$0.00</span
            >
          </div>
          <div class="flex flex-col space-y-3">
            <button
              id="modal-buy-whatsapp-button"
              class="w-full bg-green-500 text-white py-3 px-4 rounded-lg font-semibold hover:bg-green-600 transition duration-300 flex items-center justify-center space-x-2 shadow-lg hover:shadow-xl"
            >
              <i class="fab fa-whatsapp"></i>
              <span>Comprar por WhatsApp</span>
            </button>
            <button
              type="button"
              class="w-full bg-gray-200 text-gray-700 py-3 px-4 rounded-lg font-semibold hover:bg-gray-300 transition duration-300"
              onclick="closeCartModal()"
            >
              Seguir Comprando
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Custom Message Modal -->
    <div id="message-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-11/12 max-w-md mx-auto">
            <div class="flex justify-between items-center pb-3 border-b border-gray-200">
                <h3 id="message-modal-title" class="text-xl font-semibold text-gray-900">Mensaje</h3>
                <button type="button" class="text-gray-400 hover:text-gray-600" onclick="closeMessageModal()">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="py-4">
                <p id="message-modal-content" class="text-gray-700"></p>
            </div>
            <div class="pt-4 border-t border-gray-200 text-right">
                <button type="button" class="bg-pink-600 text-white py-2 px-4 rounded-lg hover:bg-pink-700 transition" onclick="closeMessageModal()">
                    Aceptar
                </button>
            </div>
        </div>
    </div>

    <script>
      // =====================================================================
      // Funciones y variables globales (accesibles desde cualquier parte)
      // =====================================================================
      window.cart = window.cart || []; // Inicializa el carrito si no existe

      function getCookie(name) {
          let cookieValue = null;
          if (document.cookie && document.cookie !== "") {
              const cookies = document.cookie.split(";");
              for (let i = 0; i < cookies.length; i++) {
                  const cookie = cookies[i].trim();
                  if (cookie.substring(0, name.length + 1) === name + "=") {
                      cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                      break;
                  }
              }
          }
          return cookieValue;
      }

      function showMessageModal(title, message) {
          document.getElementById('message-modal-title').innerText = title;
          document.getElementById('message-modal-content').innerText = message;
          document.getElementById('message-modal').classList.remove('hidden');
      }

      function closeMessageModal() {
          document.getElementById('message-modal').classList.add('hidden');
      }

      // Funciones del carrito (ahora globales)
      const cartModal = document.getElementById("cart-modal");
      const cartItemsContainer = document.getElementById("cart-items-container");
      const emptyCartMessage = document.getElementById("empty-cart-message");
      const cartTotalSpan = document.getElementById("cart-total");
      const buyWhatsappButton = document.getElementById("buy-whatsapp-button"); // Botón flotante
      const buyWhatsappCartCountSpan = document.getElementById("buy-whatsapp-cart-count"); // Contador botón flotante
      const modalBuyWhatsappButton = document.getElementById("modal-buy-whatsapp-button"); // Botón dentro del modal

      function openCartModal() {
        if (cartModal) {
            cartModal.classList.remove("hidden");
            renderCartItems(); // Asegura que los ítems se rendericen al abrir
        }
      }

      function closeCartModal() {
        if (cartModal) {
            cartModal.classList.add("hidden");
        }
      }

      function actualizarContadorCarrito() {
          const cartCountElement = document.getElementById("cart-count");
          const mobileCartCountElement = document.getElementById("mobile-cart-count");

          if (cartCountElement) {
              cartCountElement.innerText = window.cart.length;
              if (window.cart.length > 0) {
                  cartCountElement.classList.remove("hidden");
              } else {
                  cartCountElement.classList.add("hidden");
              }
          }
          if (mobileCartCountElement) {
              mobileCartCountElement.innerText = window.cart.length;
              if (window.cart.length > 0) {
                  mobileCartCountElement.classList.remove("hidden");
              } else {
                  mobileCartCountElement.classList.add("hidden");
              }
          }
          if (buyWhatsappButton && buyWhatsappCartCountSpan) {
              if (window.cart.length > 0) {
                  buyWhatsappButton.classList.remove("hidden");
                  buyWhatsappCartCountSpan.textContent = window.cart.length;
              } else {
                  buyWhatsappButton.classList.add("hidden");
              }
          }
      }

      function renderCartItems() {
        if (cartItemsContainer) {
            cartItemsContainer.innerHTML = ""; // Limpiar el contenedor actual
        }
        let total = 0;

        if (window.cart.length === 0) {
          if (emptyCartMessage) emptyCartMessage.classList.remove("hidden");
        } else {
          if (emptyCartMessage) emptyCartMessage.classList.add("hidden");
          window.cart.forEach((item, index) => {
            const itemDiv = document.createElement("div");
            itemDiv.classList.add(
              "flex",
              "justify-between",
              "items-center",
              "py-2",
              "border-b",
              "border-gray-100"
            );
            itemDiv.innerHTML = `
                        <div class="flex-1">
                            <p class="text-gray-800 font-medium">${
                              item.name
                            }</p>
                            <p class="text-gray-600 text-sm">$${parseFloat(
                              item.price
                            ).toFixed(2)}</p>
                            ${item.color && item.color !== 'N/A' ? `<p class="text-gray-500 text-xs">Color: ${item.color}</p>` : ''}
                        </div>
                        <button class="text-red-500 hover:text-red-700 ml-4" onclick="removeItemFromCart('${
                          item.variantId
                        }')">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    `;
            if (cartItemsContainer) cartItemsContainer.appendChild(itemDiv);
            total += parseFloat(item.price);
          });
        }
        if (cartTotalSpan) cartTotalSpan.textContent = `$${total.toFixed(2)}`;
      }

      function removeItemFromCart(variantIdToRemove) {
        const indexToRemove = window.cart.findIndex(
          (item) => item.variantId === variantIdToRemove
        );
        if (indexToRemove > -1) {
          window.cart.splice(indexToRemove, 1);
          showMessageModal('Producto Eliminado', 'Producto eliminado del carrito.');
          updateCartDisplay();
          actualizarContadorCarrito();
        }
      }

      function sendCartToWhatsApp() {
        if (window.cart.length === 0) {
          showMessageModal('Carrito Vacío', 'Tu carrito está vacío. Agrega productos antes de comprar.');
          return;
        }

        const whatsappNumber = '{{ whatsapp_number|default:"573007221200" }}';
        let message =
          "¡Hola! Me gustaría comprar los siguientes productos de mi carrito:\n\n";
        let total = 0;

        window.cart.forEach((item, index) => {
          message += `${index + 1}. ${item.name}`;
          if (item.color && item.color !== 'N/A') {
              message += ` (Color: ${item.color})`;
          }
          message += ` - $${item.price}\n`;
          total += parseFloat(item.price);
        });

        message += `\nTotal estimado: $${total.toFixed(2)}\n`;
        message +=
          "Por favor, confírmame la disponibilidad y el proceso de pago.";

        const whatsappUrl = `https://wa.me/${whatsappNumber}?text=${encodeURIComponent(
          message
        )}`;
        window.open(whatsappUrl, "_blank");

        // Opcional: Limpiar el carrito después de enviar el pedido
        window.cart = [];
        updateCartDisplay();
        showMessageModal('Pedido Enviado', 'Tu pedido ha sido enviado a WhatsApp. Revisa tu chat para continuar la compra.');
        closeCartModal();
        actualizarContadorCarrito();
      }

      function updateCartDisplay() {
        // Esta función ahora solo llama a renderCartItems y actualizarContadorCarrito
        // para asegurar que el modal y los contadores se actualicen.
        renderCartItems();
        actualizarContadorCarrito();
      }

      // =====================================================================
      // Lógica que se ejecuta cuando el DOM está completamente cargado
      // =====================================================================
      document.addEventListener("DOMContentLoaded", function () {
        // JavaScript para el menú móvil (Hamburger)
        const mobileMenuButton = document.getElementById("mobile-menu-button");
        const mobileMenu = document.getElementById("mobile-menu");
        const mobileCategoriesButton = document.getElementById(
          "mobile-categories-button"
        );
        const mobileCategoriesDropdown = document.getElementById(
          "mobile-categories-dropdown"
        );

        // Toggle del menú principal móvil
        if (mobileMenuButton) {
            mobileMenuButton.addEventListener("click", () => {
                if (mobileMenu) mobileMenu.classList.toggle("hidden");
                const icon = mobileMenuButton.querySelector("svg");
                if (icon) {
                    if (mobileMenu && mobileMenu.classList.contains("hidden")) {
                        icon.innerHTML =
                            '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>'; // Ícono de menú
                    } else {
                        icon.innerHTML =
                            '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>'; // Ícono de cerrar
                    }
                }
            });
        }

        // Toggle del dropdown de categorías en móvil
        if (mobileCategoriesButton) {
            mobileCategoriesButton.addEventListener("click", () => {
                if (mobileCategoriesDropdown) mobileCategoriesDropdown.classList.toggle("hidden");
                const icon = mobileCategoriesButton.querySelector("svg");
                if (icon) {
                    icon.classList.toggle("rotate-0");
                    icon.classList.toggle("rotate-180"); // Gira la flecha
                }
            });
        }

        // Slider horizontal de productos
        const slider = document.getElementById("slider");
        const slideLeft = document.getElementById("slideLeft");
        const slideRight = document.getElementById("slideRight");

        if (slider) {
          if (slideLeft) {
            slideLeft.addEventListener("click", () => {
              slider.scrollLeft -= 300;
            });
          }
          if (slideRight) {
            slideRight.addEventListener("click", () => {
              slider.scrollLeft += 300;
            });
          }
        }

        // Lógica del Carrusel de Anuncios (Mejorada)
        const carouselWrapper = document.getElementById(
            "announcement-carousel-wrapper"
        );
        const carousel = document.getElementById("announcement-carousel");
        const items = carousel
            ? carousel.querySelectorAll(".carousel-item")
            : [];
        const prevBtn = document.getElementById("prev-announcement");
        const nextBtn = document.getElementById("next-announcement");
        const indicatorsContainer = document.getElementById(
            "carousel-indicators"
        );
        const indicators = indicatorsContainer
            ? indicatorsContainer.querySelectorAll(".indicator")
            : [];

        let currentIndex = 0;
        let totalSlides = items.length;
        let autoSlideInterval;
        let dragThreshold = 50;

        function updateCarousel() {
            if (!carousel || totalSlides === 0) return;

            const offset = -currentIndex * 100;
            carousel.style.transform = `translateX(${offset}%)`;

            indicators.forEach((dot, i) => {
                dot.classList.toggle("opacity-100", i === currentIndex);
                dot.classList.toggle("opacity-50", i !== currentIndex);
            });
        }

        function goToSlide(index) {
            currentIndex = (index + totalSlides) % totalSlides;
            updateCarousel();
        }

        function startAutoSlide() {
            stopAutoSlide();
            if (totalSlides > 1) {
                autoSlideInterval = setInterval(() => {
                    goToSlide(currentIndex + 1);
                }, 5000);
            }
        }

        function stopAutoSlide() {
            clearInterval(autoSlideInterval);
        }

        if (prevBtn) {
            prevBtn.addEventListener("click", () => {
                stopAutoSlide();
                goToSlide(currentIndex - 1);
                startAutoSlide();
            });
        }

        if (nextBtn) {
            nextBtn.addEventListener("click", () => {
                stopAutoSlide();
                goToSlide(currentIndex + 1);
                startAutoSlide();
            });
        }

        if (indicatorsContainer) {
            indicators.forEach((dot, i) => {
                dot.addEventListener("click", () => {
                    stopAutoSlide();
                    goToSlide(i);
                    startAutoSlide();
                });
            });
        }

        let startX = 0;
        let isDragging = false;

        if (carouselWrapper) {
          carouselWrapper.addEventListener("touchstart", (e) => {
            startX = e.touches[0].clientX;
            isDragging = true;
            stopAutoSlide();
          });

          carouselWrapper.addEventListener("touchmove", (e) => {
            if (!isDragging) return;
            const currentX = e.touches[0].clientX;
            const diffX = currentX - startX;

            if (Math.abs(diffX) > dragThreshold) {
              if (diffX < 0) {
                goToSlide(currentIndex + 1);
              } else {
                goToSlide(currentIndex - 1);
              }
              isDragging = false;
              startX = currentX;
            }
          });

          carouselWrapper.addEventListener("touchend", () => {
            isDragging = false;
            startAutoSlide();
          });

          carouselWrapper.addEventListener("touchcancel", () => {
            isDragging = false;
            startAutoSlide();
          });
        }

        const resizeObserver = new ResizeObserver(() => {
          if (carouselWrapper && carousel) {
            updateCarousel();
          }
        });
        if (carouselWrapper) {
            resizeObserver.observe(carouselWrapper);
        }


        if (carousel && items.length > 0) {
          updateCarousel();
          startAutoSlide();
        }

        // Lógica de selección de color para variantes de producto
        document.querySelectorAll('.color-option').forEach(colorOption => {
            colorOption.addEventListener('click', function() {
                const parentProductDiv = this.closest('[data-product-id]'); // Encuentra el contenedor del producto
                const productId = parentProductDiv ? parentProductDiv.dataset.productId : null;

                const selectedVariantId = this.dataset.variantId;
                const selectedColorName = this.dataset.colorName;
                const selectedVariantImage = this.dataset.variantImage;
                const selectedVariantPrice = this.dataset.variantPrice;

                // Actualizar la imagen del producto
                const productImage = productId ? parentProductDiv.querySelector(`#product-image-${productId}`) : null;
                if (productImage) {
                    productImage.src = selectedVariantImage;
                }

                // Actualizar el precio del producto
                const productPriceSpan = productId ? parentProductDiv.querySelector(`#product-price-${productId}`) : null;
                if (productPriceSpan) {
                    productPriceSpan.textContent = `$${selectedVariantPrice}`;
                }

                // Remover la clase 'selected' de todas las opciones de color para este producto
                if (parentProductDiv) {
                    parentProductDiv.querySelectorAll('.color-option').forEach(option => {
                        option.classList.remove('selected');
                    });
                }


                // Añadir la clase 'selected' a la opción de color clickeada
                this.classList.add('selected');

                // Actualizar los data-attributes del botón "Agregar al Carrito"
                const addToCartButton = parentProductDiv ? parentProductDiv.querySelector('.btn-agregar-carrito') : null; // Usar la clase
                if (addToCartButton) {
                    addToCartButton.dataset.selectedVariantId = selectedVariantId;
                    addToCartButton.dataset.productPrice = selectedVariantPrice; // Actualiza el precio en el botón
                    addToCartButton.dataset.selectedColor = selectedColorName; // Actualiza el color en el botón
                }
            });
        });

        // Lógica para el botón de "más colores"
        document.querySelectorAll('.more-colors-button').forEach(button => {
            button.addEventListener('click', function() {
                const productId = this.dataset.productId;
                const additionalColorsContainer = document.getElementById(`additional-colors-${productId}`);
                if (additionalColorsContainer) {
                    additionalColorsContainer.classList.toggle('hidden');
                    additionalColorsContainer.classList.toggle('visible');
                    // Opcional: Cambiar el texto del botón de '+' a '-' o un icono
                    // this.innerHTML = additionalColorsContainer.classList.contains('visible') ? '<i class="fas fa-minus"></i>' : '<i class="fas fa-plus"></i>';
                }
            });
        });

        // Lógica para añadir al carrito (unificada para todos los botones .btn-agregar-carrito)
        const botonesAgregar = document.querySelectorAll(".btn-agregar-carrito");

        botonesAgregar.forEach(function (boton) {
          boton.addEventListener("click", function () {
            const productId = boton.getAttribute("data-product-id");
            const productName = boton.getAttribute("data-product-name");
            const productPrice = boton.getAttribute("data-product-price");
            const variantId = boton.getAttribute("data-selected-variant-id") || productId; // Usar productId como fallback
            const color = boton.getAttribute("data-selected-color") || 'N/A'; // Usar N/A como fallback

            // Intentar obtener la cantidad del input si existe, de lo contrario, 1
            let quantity = 1;
            // Buscar el input de cantidad dentro del mismo contenedor de producto o el más cercano
            const parentContainer = boton.closest('.bg-white'); // Ajusta este selector si tu estructura es diferente
            if (parentContainer) {
                const quantityInput = parentContainer.querySelector("input[type='number']");
                if (quantityInput) {
                    quantity = parseInt(quantityInput.value);
                }
            }


            console.log("🛒 Añadiendo:", productId, "Cantidad:", quantity, "Variante:", variantId, "Color:", color);

            if (quantity > 0) {
                fetch("/agregar-al-carrito/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": getCookie("csrftoken"),
                    },
                    body: JSON.stringify({
                        producto_id: productId,
                        quantity: quantity,
                        variant_id: variantId,
                        color: color // Enviar el color al backend si es necesario
                    }),
                })
                .then((response) => response.json())
                .then((data) => {
                    if (data.mensaje) {
                        showMessageModal("✅ Producto añadido", "Producto: " + productName + " ha sido añadido al carrito.");
                        // Guardar en window.cart (frontend)
                        for (let i = 0; i < quantity; i++) {
                            window.cart.push({ id: productId, name: productName, price: productPrice, color: color, variantId: variantId });
                        }
                        updateCartDisplay(); // Para actualizar el modal del carrito y contadores
                    } else if (data.error) {
                        showMessageModal("❌ Error", "Error: " + data.error);
                    }
                })
                .catch((error) => {
                    console.error("❌ Error al agregar al carrito (fetch):", error);
                    showMessageModal("❌ Error de Conexión", "Hubo un problema al añadir el producto al carrito. Inténtalo de nuevo.");
                });
            } else {
                showMessageModal('Cantidad Inválida', 'Por favor, ingresa una cantidad válida.');
            }
          });
        });

        // Asignar la función a los botones de WhatsApp
        if (buyWhatsappButton) {
            buyWhatsappButton.addEventListener("click", sendCartToWhatsApp);
        }
        if (modalBuyWhatsappButton) {
            modalBuyWhatsappButton.addEventListener("click", sendCartToWhatsApp);
        }

        // Inicializar la visualización del carrito al cargar la página
        updateCartDisplay();
      }); // Fin de DOMContentLoaded
    </script>
    {% block extra_js %}{% endblock %} {# Este es el nuevo bloque para JS específico de cada página #}
  </body>
</html>
