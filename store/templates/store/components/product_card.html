{% load static %}
{% load humanize %} {# Cargar el filtro humanize para intcomma #}
<div class="bg-white rounded-xl shadow hover:shadow-md transition overflow-hidden relative">
  {# Contenedor para el badge y el botón de favoritos #}
  <div class="absolute top-2 right-2 flex flex-col items-end space-y-1 z-10">
    {% if producto.badge %}
      <span class="product-badge {{ producto.get_badge_class }}">
        {{ producto.get_badge_display }}
      </span>
    {% endif %}
    {# Botón de favoritos #}
    <button class="btn-favorito"
            data-producto-id="{{ producto.id }}"
            onclick="toggleFavorito(this, {{ producto.id }})"> {# AÑADIDO: onclick #}
      <i class="fas fa-heart {% if producto.id in favoritos_ids %}active{% endif %}"></i> {# Clase 'active' movida al <i> #}
    </button>
  </div>

  {# Enlace al detalle del producto #}
  <a href="{% url 'producto_detalle' producto.id %}">
    {# Usar get_primary_image_url para obtener la imagen principal del producto con fallback explícito #}
    {% if producto.get_primary_image_url %}
        <img src="{{ producto.get_primary_image_url }}" alt="{{ producto.nombre }}" class="w-full h-48 object-cover" onerror="this.onerror=null;this.src='{% static 'img/sin_imagen.jpg' %}';">
    {% else %}
        <img src="{% static 'img/sin_imagen.jpg' %}" alt="{{ producto.nombre }}" class="w-full h-48 object-cover">
    {% endif %}
  </a>
  <div class="p-4">
    <h3 class="text-sm font-medium text-gray-700">
      {{ producto.nombre|truncatechars:40 }}
    </h3>

    {% if producto.descuento %}
      <p class="text-pink-600 font-bold text-sm mt-1">
        ${{ producto.get_precio_final|floatformat:0|intcomma }} {# Precio final con separador de miles #}
      </p>
      <p class="text-gray-500 text-xs line-through">
        ${{ producto.precio|floatformat:0|intcomma }} {# Precio original con separador de miles #}
      </p>
    {% else %}
      <p class="text-gray-900 font-bold text-sm mt-1">
        ${{ producto.precio|floatformat:0|intcomma }} {# Precio sin descuento con separador de miles #}
      </p>
    {% endif %}

    <!-- Botón Añadir al Carrito - Ahora con clase 'btn-agregar-carrito' y data-attributes -->
    <button
      class="btn-agregar-carrito mt-4 w-full bg-pink-600 text-white py-2 px-3 rounded-md text-xs font-semibold hover:bg-pink-700 transition flex items-center justify-center space-x-2"
      data-product-id="{{ producto.id }}"
      data-product-name="{{ producto.nombre }}"
      data-product-price="{{ producto.get_precio_final|floatformat:2 }}" {# Usar floatformat:2 para JS #}
      data-selected-variant-id="{% if producto.variaciones.all %}{{ producto.variaciones.first.id }}{% else %}{{ producto.id }}{% endif %}" {# Por defecto, el ID del producto si no hay variantes #}
      data-selected-color="{% if producto.variaciones.all %}{{ producto.variaciones.first.color }}{% else %}N/A{% endif %}" {# Por defecto, "N/A" si no hay variantes de color #}
      data-product-image-url="{{ producto.get_primary_image_url }}" {# Pasa la URL de la imagen principal al carrito #}
    >
      <i class="fas fa-cart-plus"></i>
      <span>Añadir al Carrito</span>
    </button>
  </div>
</div>