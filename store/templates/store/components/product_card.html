<div class="bg-white rounded-xl shadow hover:shadow-md transition overflow-hidden">
  {# Corregido: Usar 'producto_detalle' y 'producto.id' #}
  <a href="{% url 'producto_detalle' producto.id %}">
    {# CAMBIO: Usar get_primary_image_url para obtener la imagen principal del producto #}
    <img src="{{ producto.get_primary_image_url }}" alt="{{ producto.nombre }}" class="w-full h-48 object-cover">
  </a>
  <div class="p-4">
    <h3 class="text-sm font-medium text-gray-700">
      {{ producto.nombre|truncatechars:40 }}
    </h3>

    {% if producto.descuento %}
      <p class="text-pink-600 font-bold text-sm mt-1">
        ${{ producto.get_precio_final|floatformat:2 }} COP {# Asegúrate de usar floatformat para el precio final #}
      </p>
      <p class="text-gray-500 text-xs line-through">
        ${{ producto.precio|floatformat:2 }} COP {# Asegúrate de usar floatformat para el precio original #}
      </p>
    {% else %}
      <p class="text-gray-900 font-bold text-sm mt-1">
        ${{ producto.precio|floatformat:2 }} COP {# Asegúrate de usar floatformat #}
      </p>
    {% endif %}

    <!-- Botón Añadir al Carrito - Ahora con clase 'btn-agregar-carrito' y data-attributes -->
    <button
      class="btn-agregar-carrito mt-4 w-full bg-pink-600 text-white py-2 px-3 rounded-md text-xs font-semibold hover:bg-pink-700 transition flex items-center justify-center space-x-2"
      data-product-id="{{ producto.id }}"
      data-product-name="{{ producto.nombre }}"
      data-product-price="{{ producto.get_precio_final|floatformat:2 }}" {# Usar el precio final #}
      data-selected-variant-id="{% if producto.variaciones.all %}{{ producto.variaciones.first.id }}{% else %}{{ producto.id }}{% endif %}" {# Por defecto, el ID del producto si no hay variantes #}
      data-selected-color="{% if producto.variaciones.all %}{{ producto.variaciones.first.color }}{% else %}N/A{% endif %}" {# Por defecto, "N/A" si no hay variantes de color #}
      data-product-image-url="{{ producto.get_primary_image_url }}" {# NUEVO: Pasa la URL de la imagen principal al carrito #}
    >
      <i class="fas fa-cart-plus"></i>
      <span>Añadir al Carrito</span>
    </button>
  </div>
</div>